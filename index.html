<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>เครื่องคำนวณ Echoes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
  <div class="card shadow">
    <div class="card-body">
      <h2 class="card-title text-center mb-4">เครื่องคำนวณแพ็กเกจ Echoes</h2>

      <!-- เลือกโหมดราคา -->
      <div class="mb-3">
        <label for="priceMode" class="form-label">เลือกประเภทการซื้อ</label>
        <select id="priceMode" class="form-select">
          <option value="preorder">ราคาพรีออเดอร์</option>
          <option value="normal">ราคาพร้อมเติม</option>
        </select>
      </div>

      <!-- เลือกโหมดคำนวณ -->
      <div class="mb-3">
        <label for="modeSelect" class="form-label">เลือกโหมดคำนวณ</label>
        <select id="modeSelect" class="form-select">
          <option value="buttons">คำนวณจากจำนวนกระดุม</option>
          <option value="topup">คำนวณจากยอดเติมเสียงสะท้อน</option>
          <option value="budget">คำนวณจากงบประมาณ</option>
          <option value="discount">คำนวณแบบใช้ส่วนลด</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="echoesInput" class="form-label">จำนวนที่ต้องการ (กระดุม / ยอดเติม / งบ)</label>
        <input type="number" id="echoesInput" class="form-control" placeholder="เช่น 833 หรือ 1759 หรือ 1000">
      </div>

      <!-- ปุ่มคำนวณเดียว -->
      <button class="btn btn-primary w-100" onclick="calculate()">คำนวณ</button>

     <!-- ตารางเลือกส่วนลดแบบ dynamic -->
<div id="discountFormContainer" class="mt-3" style="display:none;">
  <form id="discountForm">
    <div id="discountRows"></div>
    <button type="button" class="btn btn-secondary mt-2" onclick="addRow()">เพิ่มช่อง</button>
  </form>
</div>

      function resetDiscountForm() {
  document.getElementById("discountRows").innerHTML = "";
  rowCount = 0;
}


      <div class="mt-4">
        <h5>ผลลัพธ์:</h5>
        <div id="result" class="bg-white p-3 border rounded"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const echoTopup = { 66: 60, 203: 185, 335: 305, 759: 690, 2227: 2000, 3663: 3300, 7249: 6600 };

  const preorderPrices = { 66: 31, 203: 88, 335: 146, 759: 295, 2227: 880, 3663: 1460, 7249: 2920 };
  const normalPrices = { 66: 35, 203: 105, 335: 170, 759: 340 };

  const discountTable = {
    66: {p3:31, p10:29},
    203: {p3:88, p10:82},
    335: {p3:146, p10:140},
    759: {p3:295, p10:275},
    2227: {p3:880, p10:820},
    3663: {p3:1460, p10:1370},
    7249: {p3:2920, p10:2740}
  };

  function getPriceTable(priceMode) {
    return priceMode === "preorder" ? preorderPrices : normalPrices;
  }

// ===== ส่วนที่ 2: โค้ดสร้าง dropdown dynamic =====
const packs = [66, 203, 335, 759, 2227, 3663, 7249];
const discounts = ["none", "3", "10"];

function createRow(index) {
  return `
    <div class="row mb-2" id="row-${index}">
      <div class="col-md-6">
        <select class="form-select" id="pack-${index}">
          <option value="">-- เลือกแพ็ก --</option>
          ${packs.map(p => `<option value="${p}">${p}</option>`).join("")}
        </select>
      </div>
      <div class="col-md-6">
        <select class="form-select" id="discount-${index}">
          <option value="none">ไม่ใช้ส่วนลด</option>
          <option value="3">3%</option>
          <option value="10">10%</option>
        </select>
      </div>
    </div>
  `;
}

let rowCount = 0;
function addRow() {
  rowCount++;
  document.getElementById("discountRows").insertAdjacentHTML("beforeend", createRow(rowCount));
}

// เริ่มต้นมี 5 ช่องว่างเปล่า
for (let i = 0; i < 5; i++) {
  addRow();
}



  function applyDiscounts() {
  let totalPrice = 0, totalEchoes = 0, totalTopup = 0, totalPacks = 0;
  let rows = "";

  document.querySelectorAll("#discountRows .row").forEach(row => {
    let index = row.id.split("-")[1];
    let pack = parseInt(document.getElementById(`pack-${index}`).value);
    let choice = document.getElementById(`discount-${index}`).value;

    if (!pack) return;

    let basePrice = getPriceTable(document.getElementById("priceMode").value)[pack] || 0;
    let finalPrice = basePrice;

    if (choice === "3") finalPrice = discountTable[pack].p3;
    else if (choice === "10") finalPrice = discountTable[pack].p10;

    totalPrice += finalPrice;
    totalEchoes += pack;
    totalTopup += (echoTopup[pack] || 0);
    totalPacks += 1;

    rows += `<tr><td>${pack}</td><td>${basePrice}</td><td>${finalPrice}</td></tr>`;
  });

  let html = "<table class='table table-bordered'><thead><tr><th>แพ็ก</th><th>ราคาปกติ</th><th>ราคาหลังส่วนลด</th></tr></thead><tbody>";
  html += rows + "</tbody></table>";
  html += `<p>รวมราคา: ${totalPrice} บาท</p>`;
  html += `<p>กระดุมรวม: ${totalEchoes}</p>`;
  html += `<p>ยอดเติมเสียงสะท้อนรวม: ${totalTopup}</p>`;
  html += `<p>จำนวนสิทธิ์สุ่มที่ได้: ${totalPacks}</p>`;
  document.getElementById("result").innerHTML = html;
}

  
  // ===== ฟังก์ชันหลัก =====
  function calculate() {
  let mode = document.getElementById("modeSelect").value;
  let priceMode = document.getElementById("priceMode").value;

  if (mode === "buttons") {
    document.getElementById("discountFormContainer").style.display = "none";
    resetDiscountForm();
    calculateButtons(priceMode);
  } else if (mode === "topup") {
    document.getElementById("discountFormContainer").style.display = "none";
    resetDiscountForm();
    calculateTopup(priceMode);
  } else if (mode === "budget") {
    document.getElementById("discountFormContainer").style.display = "none";
    resetDiscountForm();
    calculateBudget(priceMode);
  } else if (mode === "discount") {
    document.getElementById("discountFormContainer").style.display = "block";

    // ถ้ายังไม่มีช่อง ให้สร้าง 5 ช่องเริ่มต้น
    if (rowCount === 0) {
        for (let i = 0; i < 5; i++) {
            addRow();
        }
    }

    applyDiscounts();
}

  



  }

  // 
  function calculateButtons(priceMode) {
    let needed = parseInt(document.getElementById("echoesInput").value);
    if (isNaN(needed) || needed <= 0) {
      document.getElementById("result").innerText = "กรุณากรอกจำนวนกระดุมที่ถูกต้อง";
      return;
    }
    let options = generateOptions("buttons", needed, priceMode).filter(o=>o.echoes>=needed);
    options.sort((a,b)=>a.price-b.price);
    let best = options[0];
    document.getElementById("result").innerHTML = `
  <p>สูตรที่เลือก: ${best.desc}</p>
  <p>รวมทั้งหมด: ${best.echoes} กระดุม</p>
  <p>ราคารวม: ${best.price} บาท</p>
  <p>ยอดเติมเสียงสะท้อนรวม: ${best.topup}</p>
  <p>จำนวนสิทธิ์สุ่มที่ได้: ${best.packs}</p>`;

  }

  function calculateTopup(priceMode) {
    let neededTopup = parseInt(document.getElementById("echoesInput").value);
    if (isNaN(neededTopup) || neededTopup <= 0) {
      document.getElementById("result").innerText = "กรุณากรอกยอดเติมเสียงสะท้อนที่ถูกต้อง";
      return;
    }
    let options = generateOptions("topup", neededTopup, priceMode).filter(o=>o.topup>=neededTopup);
    options.sort((a,b)=>a.price-b.price);
    let best = options[0];
    document.getElementById("result").innerHTML = `
  <p>สูตรที่เลือก: ${best.desc}</p>
  <p>รวมทั้งหมด: ${best.echoes} กระดุม</p>
  <p>ราคารวม: ${best.price} บาท</p>
  <p>ยอดเติมเสียงสะท้อนรวม: ${best.topup}</p>
  <p>จำนวนสิทธิ์สุ่มที่ได้: ${best.packs}</p>`;

  }

  function calculateBudget(priceMode) {
  let budget = parseInt(document.getElementById("echoesInput").value);
  if (isNaN(budget) || budget <= 0) {
    document.getElementById("result").innerText = "กรุณากรอกงบประมาณที่ถูกต้อง";
    return;
  }
  let options = generateOptions("budget", budget, priceMode);

  let lower = options.filter(o=>o.price<budget).sort((a,b)=>(budget-a.price)-(budget-b.price))[0];
  let equal = options.reduce((best,o)=>Math.abs(o.price-budget)<Math.abs((best?.price||0)-budget)?o:best,null);
  let higher = options.filter(o=>o.price>budget).sort((a,b)=>(a.price-budget)-(b.price-budget))[0];

  let html = "<table class='table table-bordered'><thead><tr><th>ตัวเลือก</th><th>สูตร</th><th>ราคา</th><th>กระดุมรวม</th><th>ยอดเติมเสียงสะท้อน</th><th>สิทธิ์สุ่ม</th></tr></thead><tbody>";
  if (lower) html += `<tr><td>ต่ำกว่า</td><td>${lower.desc}</td><td>${lower.price} บาท</td><td>${lower.echoes}</td><td>${lower.topup}</td><td>${lower.packs}</td></tr>`;
  if (equal) html += `<tr><td>ใกล้เคียง/เท่ากับ</td><td>${equal.desc}</td><td>${equal.price} บาท</td><td>${equal.echoes}</td><td>${equal.topup}</td><td>${equal.packs}</td></tr>`;
  if (higher) html += `<tr><td>สูงกว่าเล็กน้อย</td><td>${higher.desc}</td><td>${higher.price} บาท</td><td>${higher.echoes}</td><td>${higher.topup}</td><td>${higher.packs}</td></tr>`;
  html += "</tbody></table>";
  document.getElementById("result").innerHTML = html;
}


</script>
</body>
</html>



